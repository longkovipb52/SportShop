@model SportShop.Models.ViewModels.ResetPasswordViewModel
@{
    ViewData["Title"] = "Đặt lại mật khẩu";
    ViewData["CustomCSS"] = "account.css";
}

<!-- Hidden elements for toast notification system -->
@if (!ViewData.ModelState.IsValid && ViewData.ModelState.ErrorCount > 0)
{
    var errors = new List<string>();
    foreach (var modelState in ViewData.ModelState.Values)
    {
        foreach (var error in modelState.Errors)
        {
            errors.Add(error.ErrorMessage);
        }
    }
    <div data-modelstate-errors='@System.Text.Json.JsonSerializer.Serialize(errors)' style="display: none;"></div>
}

@* Session success message *@
@if (Context.Session.Keys.Contains("SuccessMessage"))
{
    var successMessage = Context.Session.GetString("SuccessMessage");
    Context.Session.Remove("SuccessMessage");
    <div data-session-message="@successMessage" style="display: none;"></div>
}

<div class="auth-container">
    <div class="auth-decoration auth-decoration-1"></div>
    <div class="auth-decoration auth-decoration-2"></div>
    
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-logo">
                <span class="text-pink">LoLo</span>Sport
            </div>
            <h1 class="auth-title">Đặt lại mật khẩu</h1>
            <p class="auth-subtitle">Tạo mật khẩu mới cho tài khoản của bạn</p>
        </div>
        
        <div class="auth-body">
            <form asp-controller="Account" asp-action="ResetPassword" method="post" id="resetPasswordForm">
                <input type="hidden" asp-for="Username" />
                
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>
                        Mật khẩu phải có ít nhất 6 ký tự và bao gồm chữ cái, số và ký tự đặc biệt.
                    </small>
                </div>
                
                <div class="form-floating mb-3">
                    <input asp-for="NewPassword" type="password" class="form-control" 
                           id="newPassword"
                           placeholder=" " 
                           required />
                    <label asp-for="NewPassword">
                        <i class="fas fa-lock"></i> Mật khẩu mới
                    </label>
                    <span asp-validation-for="NewPassword" class="invalid-feedback"></span>
                </div>
                
                <div id="passwordStrength" class="mb-3 d-none">
                    <small class="text-muted">Độ mạnh mật khẩu:</small>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="strengthText" class="text-muted"></small>
                </div>
                
                <div class="form-floating mb-3">
                    <input asp-for="ConfirmPassword" type="password" class="form-control" 
                           id="confirmPassword"
                           placeholder=" " 
                           required />
                    <label asp-for="ConfirmPassword">
                        <i class="fas fa-lock"></i> Xác nhận mật khẩu
                    </label>
                    <span asp-validation-for="ConfirmPassword" class="invalid-feedback"></span>
                </div>
                
                <div id="passwordMatch" class="mb-3 d-none">
                    <small id="matchText"></small>
                </div>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-auth" id="submitBtn">
                        <span class="btn-text">
                            <i class="fas fa-check-circle me-2"></i>Đặt lại mật khẩu
                        </span>
                        <span class="btn-spinner d-none">
                            <i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...
                        </span>
                    </button>
                </div>
            </form>
            
            <div class="auth-footer mt-4">
                <a asp-controller="Account" asp-action="Login">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại đăng nhập
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/account.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const passwordStrengthDiv = document.getElementById('passwordStrength');
            const passwordMatchDiv = document.getElementById('passwordMatch');
            const strengthBar = passwordStrengthDiv?.querySelector('.progress-bar');
            const strengthText = document.getElementById('strengthText');
            const matchText = document.getElementById('matchText');
            const form = document.getElementById('resetPasswordForm');
            const submitBtn = document.getElementById('submitBtn');
            
            // Password strength checker
            if (newPasswordInput && passwordStrengthDiv) {
                newPasswordInput.addEventListener('input', function() {
                    const password = this.value;
                    
                    if (password.length === 0) {
                        passwordStrengthDiv.classList.add('d-none');
                        return;
                    }
                    
                    passwordStrengthDiv.classList.remove('d-none');
                    
                    let strength = 0;
                    let strengthLabel = '';
                    let strengthColor = '';
                    
                    // Length check
                    if (password.length >= 6) strength += 20;
                    if (password.length >= 8) strength += 10;
                    if (password.length >= 12) strength += 10;
                    
                    // Contains lowercase
                    if (/[a-z]/.test(password)) strength += 15;
                    
                    // Contains uppercase
                    if (/[A-Z]/.test(password)) strength += 15;
                    
                    // Contains numbers
                    if (/\d/.test(password)) strength += 15;
                    
                    // Contains special characters
                    if (/[^A-Za-z0-9]/.test(password)) strength += 15;
                    
                    // Set strength label and color
                    if (strength < 40) {
                        strengthLabel = 'Yếu';
                        strengthColor = 'danger';
                    } else if (strength < 60) {
                        strengthLabel = 'Trung bình';
                        strengthColor = 'warning';
                    } else if (strength < 80) {
                        strengthLabel = 'Khá';
                        strengthColor = 'info';
                    } else {
                        strengthLabel = 'Mạnh';
                        strengthColor = 'success';
                    }
                    
                    strengthBar.style.width = strength + '%';
                    strengthBar.className = `progress-bar bg-${strengthColor}`;
                    strengthText.textContent = strengthLabel;
                    strengthText.className = `text-${strengthColor}`;
                });
            }
            
            // Password match checker
            if (confirmPasswordInput && passwordMatchDiv) {
                function checkPasswordMatch() {
                    const password = newPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    
                    if (confirmPassword.length === 0) {
                        passwordMatchDiv.classList.add('d-none');
                        return;
                    }
                    
                    passwordMatchDiv.classList.remove('d-none');
                    
                    if (password === confirmPassword) {
                        matchText.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i><span class="text-success">Mật khẩu khớp</span>';
                    } else {
                        matchText.innerHTML = '<i class="fas fa-times-circle text-danger me-1"></i><span class="text-danger">Mật khẩu không khớp</span>';
                    }
                }
                
                newPasswordInput.addEventListener('input', checkPasswordMatch);
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
            
            // Handle form submission
            if (form && submitBtn) {
                form.addEventListener('submit', function(e) {
                    const btnText = submitBtn.querySelector('.btn-text');
                    const btnSpinner = submitBtn.querySelector('.btn-spinner');
                    
                    if (form.checkValidity()) {
                        btnText.classList.add('d-none');
                        btnSpinner.classList.remove('d-none');
                        submitBtn.disabled = true;
                    }
                });
            }
        });
    </script>
}
