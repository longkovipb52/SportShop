@{
    ViewData["Title"] = "Thanh toán MoMo";
}

<style>
    .payment-container {
        max-width: 500px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .momo-header {
        background: linear-gradient(135deg, #d82d8b, #e91e63);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .momo-header h3 {
        margin: 0;
        font-weight: 600;
    }
    
    .momo-header .amount {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 10px;
    }
    
    .qr-container {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        margin: 30px 0;
    }
    
    .qr-code {
        max-width: 250px;
        width: 100%;
        height: auto;
        border: 3px solid #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .instructions {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid #2196f3;
    }
    
    .instructions h5 {
        color: #1976d2;
        margin-bottom: 15px;
    }
    
    .instructions ol {
        text-align: left;
        margin: 0;
        padding-left: 20px;
    }
    
    .instructions li {
        margin-bottom: 8px;
        color: #666;
    }
    
    .status-container {
        margin-top: 30px;
    }
    
    .status-message {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: 500;
    }
    
    .status-waiting {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: #d82d8b;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
    }
    
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-block;
        margin-top: 20px;
        transition: all 0.3s ease;
    }
    
    .btn-back:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }
    
    .order-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .order-info h6 {
        margin-bottom: 10px;
        color: #495057;
    }
</style>

<div class="payment-container">
    <div class="momo-header">
        <div>
            <i class="fas fa-mobile-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <h3>Thanh toán MoMo</h3>
        </div>
        <div class="amount">
            @ViewBag.Amount?.ToString("N0") VND
        </div>
    </div>

    <div class="order-info">
        <h6><i class="fas fa-receipt"></i> Thông tin đơn hàng</h6>
        <p class="mb-1"><strong>Mã đơn hàng:</strong> @ViewBag.OrderId</p>
        <p class="mb-0"><strong>Mô tả:</strong> @ViewBag.OrderInfo</p>
    </div>

    <div class="qr-container">
        <h5 class="mb-3">
            <i class="fas fa-qrcode"></i> Quét mã QR để thanh toán
        </h5>
        @if (!string.IsNullOrEmpty(ViewBag.QrCodeUrl))
        {
            <img src="@ViewBag.QrCodeUrl" alt="MoMo QR Code" class="qr-code" />
            
            @if (!string.IsNullOrEmpty(ViewBag.PayUrl))
            {
                <div class="mt-3">
                    <a href="@ViewBag.PayUrl" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt"></i> Hoặc thanh toán trực tiếp
                    </a>
                </div>
            }
        }
        else
        {
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Không thể tạo mã QR. Vui lòng thử lại.
            </div>
        }
    </div>

    <div class="instructions">
        <h5><i class="fas fa-info-circle"></i> Hướng dẫn thanh toán</h5>
        <ol>
            <li>Mở ứng dụng <strong>MoMo</strong> trên điện thoại</li>
            <li>Chọn <strong>"Quét mã QR"</strong></li>
            <li>Quét mã QR phía trên</li>
            <li>Xác nhận thông tin và hoàn tất thanh toán</li>
            <li>Chờ hệ thống xử lý kết quả</li>
        </ol>
    </div>

    <div class="status-container">
        <div id="paymentStatus" class="status-message status-waiting">
            <div class="loading-spinner"></div>
            Đang chờ thanh toán từ MoMo...
        </div>
    </div>

    <div style="margin-top: 30px;">
        <a href="@Url.Action("Checkout", "Cart")" class="btn-back">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let checkCount = 0;
    const maxChecks = 120; // 10 phút (5 giây x 120)
    const orderId = '@ViewBag.OrderId';
    
    function checkPaymentStatus() {
        checkCount++;
        
        if (checkCount > maxChecks) {
            updateStatus('timeout', 'Hết thời gian chờ thanh toán. Vui lòng thử lại.');
            return;
        }
        
        fetch(`/Cart/CheckMoMoPaymentStatus?orderId=${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus('success', 'Thanh toán thành công! Đang chuyển hướng...');
                    setTimeout(() => {
                        window.location.href = `/Cart/OrderSuccess?orderId=${data.orderIdNew}`;
                    }, 2000);
                } else if (data.failed) {
                    updateStatus('error', 'Thanh toán thất bại: ' + data.message);
                } else {
                    // Vẫn đang chờ, tiếp tục check
                    setTimeout(checkPaymentStatus, 5000);
                }
            })
            .catch(error => {
                console.error('Error checking payment status:', error);
                setTimeout(checkPaymentStatus, 5000);
            });
    }
    
    function updateStatus(type, message) {
        const statusDiv = document.getElementById('paymentStatus');
        statusDiv.className = `status-message status-${type}`;
        
        let icon = '';
        switch(type) {
            case 'success':
                icon = '<i class="fas fa-check-circle"></i> ';
                break;
            case 'error':
                icon = '<i class="fas fa-times-circle"></i> ';
                break;
            case 'timeout':
                icon = '<i class="fas fa-clock"></i> ';
                break;
            default:
                icon = '<div class="loading-spinner"></div>';
        }
        
        statusDiv.innerHTML = icon + message;
    }
    
    // Bắt đầu check status sau 5 giây
    setTimeout(checkPaymentStatus, 5000);
    
    // Auto-refresh QR code mỗi 15 phút để tránh expire
    setTimeout(() => {
        location.reload();
    }, 15 * 60 * 1000);
});
</script>
