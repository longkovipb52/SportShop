@using Microsoft.AspNetCore.Mvc.Rendering
@model SportShop.Models.ViewModels.OrderHistoryViewModel
@{
    ViewData["Title"] = "L·ªãch s·ª≠ ƒë∆°n h√†ng";
    ViewData["CustomCSS"] = "order.css";
    var statistics = ViewBag.Statistics as SportShop.Models.ViewModels.OrderStatusStatisticsViewModel;
}

<section class="order-hero">
    <div class="order-hero-overlay"></div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <div class="hero-content">
                    <div class="order-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <h1 class="display-5 fw-bold text-white mb-2">L·ªãch s·ª≠ ƒë∆°n h√†ng</h1>
                    <p class="lead text-white-50">Theo d√µi v√† qu·∫£n l√Ω t·∫•t c·∫£ ƒë∆°n h√†ng c·ªßa b·∫°n</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="order-content py-5">
    <div class="container">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show animate__animated animate__bounceIn" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show animate__animated animate__shakeX" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- Statistics Cards -->
        @if (statistics != null)
        {
            <div class="row g-3 mb-4">
                <div class="col-md-2">
                    <div class="stat-card stat-pending">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>@statistics.PendingCount</h3>
                            <p>Ch·ªù x·ª≠ l√Ω</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card stat-processing">
                        <div class="stat-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="stat-info">
                            <h3>@statistics.ProcessingCount</h3>
                            <p>ƒêang x·ª≠ l√Ω</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card stat-shipping">
                        <div class="stat-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-info">
                            <h3>@statistics.ShippingCount</h3>
                            <p>ƒêang giao</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card stat-completed">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>@statistics.CompletedCount</h3>
                            <p>Ho√†n th√†nh</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card stat-cancelled">
                        <div class="stat-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>@statistics.CancelledCount</h3>
                            <p>ƒê√£ h·ªßy</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card stat-total">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3>@statistics.TotalSpent.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))</h3>
                            <p>T·ªïng chi ti√™u</p>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Filters and Search -->
        <div class="filter-section mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <form method="get" class="order-search-form">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" name="search" 
                                   value="@Model.SearchTerm" 
                                   placeholder="T√¨m theo m√£ ƒë∆°n h√†ng ho·∫∑c t√™n s·∫£n ph·∫©m...">
                            <button class="btn btn-order-search" type="submit">
                                <i class="fas fa-search me-1"></i>T√¨m ki·∫øm
                            </button>
                        </div>
                        <input type="hidden" name="status" value="@Model.StatusFilter">
                    </form>
                </div>
                <div class="col-md-3">
                    <form method="get" class="status-filter">
                        <select class="form-select" name="status" onchange="this.form.submit()" id="statusFilter">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
                            <option value="Processing">ƒêang x·ª≠ l√Ω</option>
                            <option value="Shipping">ƒêang giao</option>
                            <option value="Completed">Ho√†n th√†nh</option>
                            <option value="Cancelled">ƒê√£ h·ªßy</option>
                        </select>
                        <input type="hidden" name="search" value="@Model.SearchTerm">
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                var statusFilter = document.getElementById('statusFilter');
                                var currentStatus = '@Html.Raw(Model.StatusFilter ?? "")';
                                if (statusFilter && currentStatus) {
                                    statusFilter.value = currentStatus;
                                }
                            });
                        </script>
                    </form>
                </div>
                <div class="col-md-3 text-end">
                    <span class="result-count">
                        <i class="fas fa-list-alt me-1"></i>
                        T√¨m th·∫•y <strong>@Model.TotalOrders</strong> ƒë∆°n h√†ng
                    </span>
                </div>
            </div>
        </div>

        <!-- Orders List -->
        @if (Model.Orders.Any())
        {
            <div class="orders-list">
                @foreach (var order in Model.Orders)
                {
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-info">
                                <h5 class="order-id">
                                    <i class="fas fa-receipt me-2"></i>
                                    ƒê∆°n h√†ng #@order.OrderID
                                </h5>
                                <p class="order-date">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    @order.OrderDate.ToString("dd/MM/yyyy HH:mm")
                                </p>
                            </div>
                            <div class="order-status">
                                <span class="status-badge @order.StatusClass">@order.StatusDisplay</span>
                            </div>
                        </div>

                        <div class="order-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="order-items">
                                        @foreach (var item in order.Items)
                                        {
                                            <div class="order-item">
                                                <div class="item-image">
                                                    @if (!string.IsNullOrEmpty(item.ProductImage))
                                                    {
                                                        <img src="~/upload/product/@item.ProductImage" alt="@item.ProductName" 
                                                             onerror="this.src='~/image/loading-placeholder.png'">
                                                    }
                                                    else
                                                    {
                                                        <img src="~/image/loading-placeholder.png" alt="@item.ProductName">
                                                    }
                                                </div>
                                                <div class="item-info">
                                                    <h6 class="item-name">@item.ProductName</h6>
                                                    <p class="item-details">
                                                        @if (!string.IsNullOrEmpty(item.Size))
                                                        {
                                                            <span class="item-size">Size: @item.Size</span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(item.Color))
                                                        {
                                                            <span class="item-color">M√†u: @item.Color</span>
                                                        }
                                                    </p>
                                                    <p class="item-quantity">S·ªë l∆∞·ª£ng: @item.Quantity</p>
                                                </div>
                                                <div class="item-price">
                                                    @item.UnitPrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))
                                                </div>
                                            </div>
                                        }
                                        @if (order.ItemCount > 3)
                                        {
                                            <div class="more-items">
                                                <i class="fas fa-ellipsis-h me-1"></i>
                                                v√† @(order.ItemCount - 3) s·∫£n ph·∫©m kh√°c
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="order-summary">
                                        <div class="summary-item">
                                            <span class="label">Giao h√†ng:</span>
                                            <span class="value">@order.ShippingName</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="label">Thanh to√°n:</span>
                                            <span class="value">@order.PaymentMethod</span>
                                        </div>
                                        <div class="summary-item total">
                                            <span class="label">T·ªïng ti·ªÅn:</span>
                                            <span class="value">@order.TotalAmount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="order-footer">
                            <div class="order-actions">
                                <a href="@Url.Action("Detail", new { id = order.OrderID })" 
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                                </a>
                                
                                @* Cancel button - Only show for Pending orders *@
                                @if (order.Status == "Pending" || order.Status == "Ch·ªù x·ª≠ l√Ω" || order.StatusDisplay == "Ch·ªù x·ª≠ l√Ω")
                                {
                                    <button type="button" 
                                            class="btn btn-outline-danger cancel-order-btn" 
                                            data-order-id="@order.OrderID">
                                        <i class="fas fa-times-circle me-1"></i>H·ªßy ƒë∆°n h√†ng
                                    </button>
                                }
                                
                                @if (order.Status == "Completed" || order.Status == "Ho√†n th√†nh" || order.StatusDisplay == "Ho√†n th√†nh")
                                {
                                    <a href="@Url.Action("Print", new { id = order.OrderID })" 
                                       class="btn btn-outline-secondary" target="_blank">
                                        <i class="fas fa-print me-1"></i>In h√≥a ƒë∆°n
                                    </a>
                                    <button type="button" 
                                            class="btn btn-outline-success review-order-btn" 
                                            data-order-id="@order.OrderID"
                                            data-order-items='@System.Text.Json.JsonSerializer.Serialize(order.Items.Select(i => new { i.ProductID, i.ProductName, i.ProductImage }).ToList())'>
                                        <i class="fas fa-star me-1"></i>ƒê√°nh gi√° ƒë∆°n h√†ng
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            @if (Model.TotalPages > 1)
            {
                <nav aria-label="Order history pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        @if (Model.CurrentPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = 1, status = Model.StatusFilter, search = Model.SearchTerm })">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage - 1, status = Model.StatusFilter, search = Model.SearchTerm })">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        }

                        @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = i, status = Model.StatusFilter, search = Model.SearchTerm })">@i</a>
                            </li>
                        }

                        @if (Model.CurrentPage < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage + 1, status = Model.StatusFilter, search = Model.SearchTerm })">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = Model.TotalPages, status = Model.StatusFilter, search = Model.SearchTerm })">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
                <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. H√£y b·∫Øt ƒë·∫ßu mua s·∫Øm ngay!</p>
                <a href="/Product" class="btn btn-primary">
                    <i class="fas fa-shopping-cart me-2"></i>B·∫Øt ƒë·∫ßu mua s·∫Øm
                </a>
            </div>
        }
    </div>
</section>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelOrderModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cancelOrderForm">
                    <input type="hidden" id="cancelOrderId" name="orderId">
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>L∆∞u √Ω:</strong> B·∫°n s·∫Øp h·ªßy ƒë∆°n h√†ng n√†y. H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.
                    </div>
                    
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">
                            L√Ω do h·ªßy ƒë∆°n h√†ng <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="cancelReason" 
                                  name="cancelReason" 
                                  rows="4" 
                                  placeholder="Vui l√≤ng cho ch√∫ng t√¥i bi·∫øt l√Ω do b·∫°n mu·ªën h·ªßy ƒë∆°n h√†ng..."
                                  required
                                  maxlength="500"></textarea>
                        <small class="text-muted">T·ªëi ƒëa 500 k√Ω t·ª±</small>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>ƒê√≥ng
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-check me-1"></i>X√°c nh·∫≠n h·ªßy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Product Selection Modal -->
<div class="modal fade" id="productSelectionModal" tabindex="-1" aria-labelledby="productSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content product-selection-modal-content">
            <div class="modal-header product-selection-modal-header">
                <h5 class="modal-title" id="productSelectionModalLabel">
                    <i class="fas fa-star me-2"></i>Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ ƒë√°nh gi√°
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body product-selection-modal-body">
                <p class="text-muted mb-3">Vui l√≤ng ch·ªçn s·∫£n ph·∫©m b·∫°n mu·ªën ƒë√°nh gi√°:</p>
                <div id="productSelectionList" class="product-selection-list">
                    <!-- Products will be loaded here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content review-modal-content">
            <div class="modal-header review-modal-header">
                <h5 class="modal-title" id="reviewModalLabel">
                    <i class="fas fa-star-half-alt me-2"></i>ƒê√°nh gi√° s·∫£n ph·∫©m
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body review-modal-body">
                <form id="reviewForm">
                    <input type="hidden" id="reviewOrderId" name="orderId">
                    <input type="hidden" id="reviewProductId" name="productId">
                    <input type="hidden" id="reviewId" name="reviewId" value="">
                    <input type="hidden" id="isEditMode" value="false">
                    
                    <div class="product-review-info">
                        <div class="product-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <h6 class="product-name-review" id="productNameReview"></h6>
                        <div id="editModeNotice" class="alert alert-info mt-3" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="editModeText"></span>
                        </div>
                    </div>

                    <div class="rating-section mb-4">
                        <label class="form-label">ƒê√°nh gi√° c·ªßa b·∫°n <span class="text-danger">*</span></label>
                        <div class="star-rating">
                            <input type="radio" name="rating" value="5" id="star5">
                            <label for="star5" title="5 sao - Xu·∫•t s·∫Øc">
                                <i class="fas fa-star"></i>
                            </label>
                            <input type="radio" name="rating" value="4" id="star4">
                            <label for="star4" title="4 sao - T·ªët">
                                <i class="fas fa-star"></i>
                            </label>
                            <input type="radio" name="rating" value="3" id="star3">
                            <label for="star3" title="3 sao - B√¨nh th∆∞·ªùng">
                                <i class="fas fa-star"></i>
                            </label>
                            <input type="radio" name="rating" value="2" id="star2">
                            <label for="star2" title="2 sao - K√©m">
                                <i class="fas fa-star"></i>
                            </label>
                            <input type="radio" name="rating" value="1" id="star1">
                            <label for="star1" title="1 sao - R·∫•t k√©m">
                                <i class="fas fa-star"></i>
                            </label>
                        </div>
                        <div class="rating-text" id="ratingText">Ch·ªçn s·ªë sao ƒë·ªÉ ƒë√°nh gi√°</div>
                    </div>

                    <div class="mb-4">
                        <label for="reviewComment" class="form-label">Nh·∫≠n x√©t c·ªßa b·∫°n</label>
                        <textarea class="form-control review-textarea" 
                                  id="reviewComment" 
                                  name="comment" 
                                  rows="4" 
                                  placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m..."></textarea>
                        <small class="text-muted">T·ªëi ƒëa 500 k√Ω t·ª±</small>
                    </div>

                    <div class="review-actions">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>H·ªßy
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>G·ª≠i ƒë√°nh gi√°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="~/css/review-modal.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
    <script>
        // Show product selection modal
        async function showProductSelectionModal(orderId, products) {
            const productList = document.getElementById('productSelectionList');
            productList.innerHTML = '';
            
            // Load review status for each product
            for (const product of products) {
                try {
                    const response = await fetch(`@Url.Action("GetReview", "OrderHistory")?orderId=${orderId}&productId=${product.ProductID}`);
                    const result = await response.json();
                    
                    const productItem = document.createElement('div');
                    productItem.className = 'product-selection-item';
                    
                    const hasReview = result.success;
                    const canEdit = hasReview && result.canEdit;
                    
                    productItem.innerHTML = `
                        <div class="d-flex align-items-center">
                            <img src="/upload/product/${product.ProductImage}" 
                                 alt="${product.ProductName}" 
                                 class="product-thumb me-3"
                                 onerror="this.src='/image/loading-placeholder.png'">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${product.ProductName}</h6>
                                ${hasReview ? `
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        ƒê√£ ƒë√°nh gi√° ${result.rating} <i class="fas fa-star text-warning"></i>
                                        ${canEdit ? ' - C√≥ th·ªÉ ch·ªânh s·ª≠a' : ' - Kh√¥ng th·ªÉ ch·ªânh s·ª≠a'}
                                    </small>
                                ` : `
                                    <small class="text-muted">
                                        <i class="far fa-star me-1"></i>Ch∆∞a ƒë√°nh gi√°
                                    </small>
                                `}
                            </div>
                            <button class="btn ${hasReview ? (canEdit ? 'btn-outline-primary' : 'btn-outline-secondary') : 'btn-primary'} btn-sm select-product-btn"
                                    data-order-id="${orderId}"
                                    data-product-id="${product.ProductID}"
                                    data-product-name="${product.ProductName}"
                                    data-has-review="${hasReview}"
                                    ${!hasReview || canEdit ? '' : 'disabled'}>
                                <i class="fas ${hasReview ? 'fa-edit' : 'fa-star'} me-1"></i>
                                ${hasReview ? (canEdit ? 'Ch·ªânh s·ª≠a' : 'ƒê√£ ƒë√°nh gi√°') : 'ƒê√°nh gi√°'}
                            </button>
                        </div>
                    `;
                    
                    productList.appendChild(productItem);
                } catch (error) {
                    console.error('Error loading review status:', error);
                }
            }
            
            // Add click handlers to select buttons
            document.querySelectorAll('.select-product-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    const productId = this.getAttribute('data-product-id');
                    const productName = this.getAttribute('data-product-name');
                    const hasReview = this.getAttribute('data-has-review') === 'true';
                    
                    // Close selection modal
                    const selectionModal = bootstrap.Modal.getInstance(document.getElementById('productSelectionModal'));
                    selectionModal.hide();
                    
                    // Open review modal
                    setTimeout(() => {
                        openReviewModal(orderId, productName, productId, hasReview);
                    }, 300);
                });
            });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('productSelectionModal'));
            modal.show();
        }

        // Review Modal Functions
        async function openReviewModal(orderId, productName, productId, isEdit = false) {
            document.getElementById('reviewOrderId').value = orderId;
            document.getElementById('reviewProductId').value = productId;
            document.getElementById('productNameReview').textContent = productName;
            
            // Reset form
            document.getElementById('reviewForm').reset();
            document.getElementById('reviewId').value = '';
            document.getElementById('isEditMode').value = 'false';
            
            // Reset edit notice safely
            const editNotice = document.getElementById('editModeNotice');
            if (editNotice) {
                editNotice.style.display = 'none';
            }
            
            // Reset rating text
            const ratingText = document.getElementById('ratingText');
            if (ratingText) {
                ratingText.textContent = 'Ch·ªçn s·ªë sao ƒë·ªÉ ƒë√°nh gi√°';
            }
            
            // Reset star labels
            document.querySelectorAll('.star-rating label').forEach(label => {
                label.classList.remove('selected');
            });
            
            // Re-enable all form elements (in case they were disabled)
            document.getElementById('reviewForm').querySelectorAll('input, textarea, button[type="submit"]').forEach(el => {
                el.disabled = false;
            });
            
            // Check if product has been reviewed
            if (isEdit) {
                try {
                    const response = await fetch(`@Url.Action("GetReview", "OrderHistory")?orderId=${orderId}&productId=${productId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        // Set edit mode
                        document.getElementById('isEditMode').value = 'true';
                        document.getElementById('reviewId').value = result.reviewId;
                        
                        // Load existing review data
                        if (result.rating) {
                            const ratingInput = document.querySelector(`input[name="rating"][value="${result.rating}"]`);
                            if (ratingInput) {
                                ratingInput.checked = true;
                                ratingInput.dispatchEvent(new Event('change'));
                            }
                        }
                        
                        if (result.comment) {
                            document.getElementById('reviewComment').value = result.comment;
                        }
                        
                        // Show edit notice
                        const editNoticeEl = document.getElementById('editModeNotice');
                        const editTextEl = document.getElementById('editModeText');
                        
                        if (editNoticeEl && editTextEl) {
                            if (result.canEdit) {
                                const hoursRemaining = Math.floor(result.hoursRemaining);
                                const minutesRemaining = Math.floor((result.hoursRemaining - hoursRemaining) * 60);
                                editTextEl.innerHTML = `B·∫°n ƒëang ch·ªânh s·ª≠a ƒë√°nh gi√°. C√≤n <strong>${hoursRemaining} gi·ªù ${minutesRemaining} ph√∫t</strong> ƒë·ªÉ ch·ªânh s·ª≠a.`;
                                editNoticeEl.className = 'alert alert-info mt-3';
                            } else {
                                editTextEl.innerHTML = 'ƒê√£ h·∫øt th·ªùi gian ch·ªânh s·ª≠a ƒë√°nh gi√° (24 gi·ªù). B·∫°n ch·ªâ c√≥ th·ªÉ xem l·∫°i ƒë√°nh gi√°.';
                                editNoticeEl.className = 'alert alert-warning mt-3';
                                // Disable form
                                document.getElementById('reviewForm').querySelectorAll('input, textarea, button[type="submit"]').forEach(el => {
                                    el.disabled = true;
                                });
                            }
                            editNoticeEl.style.display = 'block';
                        }
                        
                        // Update modal title
                        const modalTitle = document.getElementById('reviewModalLabel');
                        if (modalTitle) {
                            modalTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a ƒë√°nh gi√°';
                        }
                    }
                } catch (error) {
                    console.error('Error loading review:', error);
                }
            } else {
                // New review mode
                const modalTitle = document.getElementById('reviewModalLabel');
                if (modalTitle) {
                    modalTitle.innerHTML = '<i class="fas fa-star-half-alt me-2"></i>ƒê√°nh gi√° s·∫£n ph·∫©m';
                }
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
            modal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Handle cancel order button
            document.querySelectorAll('.cancel-order-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    document.getElementById('cancelOrderId').value = orderId;
                    
                    const modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
                    modal.show();
                });
            });

            // Handle cancel order form submission
            document.getElementById('cancelOrderForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const orderId = document.getElementById('cancelOrderId').value;
                const cancelReason = document.getElementById('cancelReason').value.trim();
                
                if (!cancelReason) {
                    alert('Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng!');
                    return;
                }
                
                // Show loading
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
                submitBtn.disabled = true;
                
                try {
                    const formData = new FormData();
                    formData.append('orderId', orderId);
                    formData.append('cancelReason', cancelReason);
                    
                    const response = await fetch('@Url.Action("CancelOrder", "OrderHistory")', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal'));
                        modal.hide();
                        
                        // Show success message
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show animate__animated animate__bounceIn';
                        alertDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>${result.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.querySelector('.order-content .container').insertBefore(
                            alertDiv, 
                            document.querySelector('.order-content .container').firstChild
                        );
                        
                        // Reload page after 2 seconds
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        alert(result.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Reset cancel modal when closed
            const cancelModal = document.getElementById('cancelOrderModal');
            if (cancelModal) {
                cancelModal.addEventListener('hidden.bs.modal', function() {
                    document.getElementById('cancelOrderForm').reset();
                });
            }

            // Handle review order button (new approach - single button)
            document.querySelectorAll('.review-order-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    const orderItems = JSON.parse(this.getAttribute('data-order-items'));
                    
                    showProductSelectionModal(orderId, orderItems);
                });
            });

            // Initialize review buttons with check for existing reviews (legacy support)
            document.querySelectorAll('.review-btn').forEach(btn => {
                const orderId = btn.getAttribute('data-order-id');
                const productId = btn.getAttribute('data-product-id');
                const productName = btn.getAttribute('data-product-name');
                
                // Check if already reviewed
                fetch(`@Url.Action("GetReview", "OrderHistory")?orderId=${orderId}&productId=${productId}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Has review - change button
                            const btnText = btn.querySelector('.review-btn-text');
                            const btnIcon = btn.querySelector('i');
                            
                            if (result.canEdit) {
                                btnText.textContent = 'S·ª≠a ƒë√°nh gi√°';
                                btnIcon.className = 'fas fa-edit me-1';
                                btn.classList.remove('btn-outline-success');
                                btn.classList.add('btn-outline-warning');
                            } else {
                                btnText.textContent = 'Xem ƒë√°nh gi√°';
                                btnIcon.className = 'fas fa-eye me-1';
                                btn.classList.remove('btn-outline-success');
                                btn.classList.add('btn-outline-info');
                            }
                            
                            // Add click handler for edit mode
                            btn.addEventListener('click', () => {
                                openReviewModal(orderId, productName, productId, true);
                            });
                        } else {
                            // No review - normal click handler
                            btn.addEventListener('click', () => {
                                openReviewModal(orderId, productName, productId, false);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error checking review:', error);
                        // Fallback to normal handler
                        btn.addEventListener('click', () => {
                            openReviewModal(orderId, productName, productId, false);
                        });
                    });
            });

            // Star rating interaction
            const starInputs = document.querySelectorAll('.star-rating input');
            const starLabels = document.querySelectorAll('.star-rating label');
            const ratingText = document.getElementById('ratingText');

            const ratingTexts = {
                '5': 'Xu·∫•t s·∫Øc! ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                '4': 'T·ªët! ‚≠ê‚≠ê‚≠ê‚≠ê',
                '3': 'B√¨nh th∆∞·ªùng ‚≠ê‚≠ê‚≠ê',
                '2': 'K√©m ‚≠ê‚≠ê',
                '1': 'R·∫•t k√©m ‚≠ê'
            };

            starInputs.forEach((input, index) => {
                input.addEventListener('change', function() {
                    const rating = this.value;
                    ratingText.textContent = ratingTexts[rating];
                    
                    // Update visual state
                    starLabels.forEach((label, labelIndex) => {
                        if (labelIndex >= starInputs.length - index) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                    });
                });
            });

            // Hover effect for stars
            starLabels.forEach((label, index) => {
                label.addEventListener('mouseenter', function() {
                    starLabels.forEach((l, i) => {
                        if (i >= starLabels.length - index - 1) {
                            l.classList.add('hover');
                        } else {
                            l.classList.remove('hover');
                        }
                    });
                });
            });

            document.querySelector('.star-rating').addEventListener('mouseleave', function() {
                starLabels.forEach(l => l.classList.remove('hover'));
            });

            // Handle review form submission
            document.getElementById('reviewForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const isEditMode = document.getElementById('isEditMode').value === 'true';
                const reviewId = document.getElementById('reviewId').value;
                const orderId = document.getElementById('reviewOrderId').value;
                const productId = document.getElementById('reviewProductId').value;
                const rating = document.querySelector('input[name="rating"]:checked')?.value;
                const comment = document.getElementById('reviewComment').value;

                if (!rating) {
                    alert('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!');
                    return;
                }

                // Show loading
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang g·ª≠i...';
                submitBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('rating', rating);
                    formData.append('comment', comment);
                    
                    let url, actionText;
                    if (isEditMode) {
                        // Update existing review
                        url = '@Url.Action("UpdateReview", "OrderHistory")';
                        formData.append('reviewId', reviewId);
                        actionText = 'ƒêang c·∫≠p nh·∫≠t...';
                    } else {
                        // Create new review
                        url = '@Url.Action("SubmitReview", "OrderHistory")';
                        formData.append('orderId', orderId);
                        formData.append('productId', productId);
                        actionText = 'ƒêang g·ª≠i...';
                    }

                    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${actionText}`;

                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Hide modal first
                        const modal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
                        modal.hide();

                        // Show toast notification using the existing toast system
                        if (typeof showToast === 'function') {
                            if (result.voucherAssigned) {
                                // Special toast for voucher assignment
                                showToast(
                                    `üéâ ${result.message}`, 
                                    'success', 
                                    6000 // Show longer for voucher notification
                                );
                            } else {
                                // Regular success toast
                                showToast(result.message, 'success');
                            }
                        } else {
                            // Fallback if toast function not available
                            alert(result.message);
                        }

                        // Reload page to update button status
                        setTimeout(() => {
                            location.reload();
                        }, 2000);

                    } else {
                        // Show error using toast system
                        if (typeof showToast === 'function') {
                            showToast(result.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
                        } else {
                            alert(result.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    // Show error using toast system
                    if (typeof showToast === 'function') {
                        showToast('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
                    } else {
                        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
                    }
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Reset modal when closed
            const reviewModal = document.getElementById('reviewModal');
            if (reviewModal) {
                reviewModal.addEventListener('hidden.bs.modal', function() {
                    // Reset form
                    document.getElementById('reviewForm').reset();
                    document.getElementById('reviewId').value = '';
                    document.getElementById('isEditMode').value = 'false';
                    
                    // Hide edit notice
                    const editNotice = document.getElementById('editModeNotice');
                    if (editNotice) {
                        editNotice.style.display = 'none';
                    }
                    
                    // Re-enable all form elements
                    document.getElementById('reviewForm').querySelectorAll('input, textarea, button[type="submit"]').forEach(el => {
                        el.disabled = false;
                    });
                    
                    // Reset stars
                    document.querySelectorAll('.star-rating label').forEach(label => {
                        label.classList.remove('selected');
                    });
                    
                    // Reset rating text
                    const ratingText = document.getElementById('ratingText');
                    if (ratingText) {
                        ratingText.textContent = 'Ch·ªçn s·ªë sao ƒë·ªÉ ƒë√°nh gi√°';
                    }
                });
            }

            // Auto-hide alerts
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.classList.add('animate__animated', 'animate__fadeOut');
                    setTimeout(() => {
                        alert.remove();
                    }, 1000);
                }, 5000);
            });

            // Animate cards on scroll
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate__animated', 'animate__fadeInUp');
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.order-card').forEach(card => {
                observer.observe(card);
            });
        });
    </script>
}